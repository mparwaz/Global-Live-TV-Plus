<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Live TV Plus</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="icon" type="image/jpeg" href="https://raw.githubusercontent.com/mparwaz/Global-Live-TV-Plus/refs/heads/main/1765952521193.jpg">

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root {
            --sidebar-bg: #0d141f; --main-bg: #070b13; --card-bg: #151f2e;
            --accent: #2081e2; --blue-main: #2081e2; --text-main: #e6f1ff;
            --text-muted: #8892b0; --border: #1e293b; --fav-red: #ff4d4d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--main-bg); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* --- Sidebar --- */
        .sidebar { width: 280px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 1000; flex-shrink: 0; }
        @media (max-width: 768px) { .sidebar { position: fixed; height: 100%; transform: translateX(-100%); transition: 0.3s ease; } .sidebar.active { transform: translateX(0); } }
        
        .sidebar-header { padding: 25px 20px 5px; font-weight: 800; font-size: 1.2rem; color: var(--blue-main); }
        
        .api-status { padding: 0 20px 15px; display: flex; align-items: center; justify-content: space-between; font-size: 10px; color: var(--text-muted); }
        .status-info { display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #ff9f43; }
        .status-dot.online { background: #4cd137; box-shadow: 0 0 8px #4cd137; }
        
        .ctrl-btn { cursor: pointer; color: var(--text-muted); transition: 0.2s; padding: 4px; border-radius: 4px; font-size: 18px !important; }
        .ctrl-btn:hover { color: var(--blue-main); background: rgba(255,255,255,0.05); }

        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px 0; }
        .sidebar-section { color: var(--text-muted); font-size: 10px; padding: 15px 20px 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; }
        .nav-item { padding: 10px 20px; display: flex; align-items: center; gap: 12px; cursor: pointer; font-size: 13px; color: var(--text-main); transition: 0.2s; }
        .nav-item:hover { background: rgba(255,255,255,0.03); }
        .nav-item.active { background: rgba(32, 129, 226, 0.15); color: white; border-left: 3px solid var(--blue-main); }

        /* --- Main UI --- */
        .main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; height: 100vh; }
        header { height: 64px; padding: 0 20px; display: flex; align-items: center; gap: 15px; background: var(--main-bg); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .menu-btn { cursor: pointer; color: var(--blue-main); display: none; }
        @media (max-width: 768px) { .menu-btn { display: block; } }

        .search-bar { background: #151f2e; border: 1px solid var(--border); border-radius: 8px; padding: 10px 15px; display: flex; align-items: center; flex: 0 1 500px; margin: 0 auto; width: 100%; }
        .search-bar input { background: transparent; border: none; color: white; outline: none; margin-left: 10px; width: 100%; font-size: 14px; }

        #channel-grid { flex: 1; padding: 20px; overflow-y: auto; display: grid; grid-template-columns: repeat(2, 1fr); grid-auto-rows: min-content; gap: 15px; align-content: start; }
        @media (min-width: 1024px) { #channel-grid { grid-template-columns: repeat(6, 1fr); gap: 20px; } }

        .channel-card { background: var(--card-bg); border-radius: 12px; padding: 12px; display: flex; flex-direction: column; align-items: center; aspect-ratio: 1 / 1.15; cursor: pointer; border: 1px solid var(--border); position: relative; overflow: hidden; transition: 0.2s ease; }
        .channel-card:hover { border-color: var(--blue-main); background: #1c283a; transform: translateY(-2px); }
        .channel-card img { width: 100%; height: 45%; object-fit: contain; pointer-events: none; margin-top: 10px; }
        
        .ch-info { width: 100%; text-align: center; margin-top: auto; padding-bottom: 5px; }
        .ch-name { font-weight: 600; font-size: 0.75rem; color: #fff; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 6px; }
        
        .meta-tags { display: flex; justify-content: center; gap: 4px; flex-wrap: wrap; }
        .ch-tag { font-size: 8px; font-weight: 800; background: rgba(32, 129, 226, 0.15); color: var(--blue-main); padding: 2px 5px; border-radius: 4px; text-transform: uppercase; }

        /* Empty & Offline States */
        .empty-container, .offline-container { grid-column: 1/-1; text-align: center; padding: 80px 20px; color: var(--text-muted); }
        .offline-container .material-icons { font-size: 56px; margin-bottom: 15px; color: var(--text-muted); opacity: 0.5; }
        .offline-container h3 { color: var(--text-main); margin-bottom: 10px; font-size: 1.2rem; }
        .offline-container p { font-size: 14px; margin-bottom: 20px; line-height: 1.5; }
        .retry-btn { background: var(--blue-main); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }

        .heart-btn { position: absolute; top: 10px; right: 10px; color: rgba(255,255,255,0.2); font-size: 18px !important; z-index: 10; }
        .heart-btn.is-fav { color: var(--fav-red); }

        /* Player Modal */
        .player-modal { position: fixed; inset: 0; background: #000; display: none; z-index: 9999; flex-direction: column; }
        .player-header { position: absolute; top: 0; left: 0; right: 0; height: 70px; display: flex; justify-content: flex-end; align-items: center; padding: 0 20px; z-index: 10002; }
        .close-btn { background: rgba(0,0,0,0.6); color: white; border: 1px solid rgba(255,255,255,0.2); width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .player-container { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        video { width: 100%; max-width: 1200px; height: auto; max-height: 100%; }
        
        #player-error { display: none; position: absolute; text-align: center; z-index: 10; padding: 20px; }

        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 998; }
        .sidebar-overlay.active { display: block; }
    </style>
</head>
<body>

<div id="overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

<aside id="sidebar" class="sidebar">
    <div class="sidebar-header">Global Live TV+</div>
    
    <div class="api-status">
        <div class="status-info">
            <div id="status-dot" class="status-dot"></div>
            <span id="status-text">Connecting...</span>
        </div>
        <div class="status-controls">
            <span class="material-icons ctrl-btn" onclick="manualRefresh()">refresh</span>
            <span class="material-icons ctrl-btn" onclick="clearCache()">delete_forever</span>
        </div>
    </div>

    <div class="sidebar-content">
        <div class="sidebar-section">Explore</div>
        <div id="fav-link" class="nav-item" onclick="showFavorites()"><span class="material-icons">favorite</span> My Favorites</div>
        <div id="cat-countries" class="nav-item" onclick="loadM3U('countries')"><span class="material-icons">public</span> Countries üåé</div>
        
        <div class="sidebar-section">Languages</div>
        <div id="language-list"></div>

        <div class="sidebar-section">Categories</div>
        <div id="category-list"></div>
    </div>
</aside>

<main class="main-content">
    <header>
        <span class="material-icons menu-btn" onclick="toggleSidebar()">menu</span>
        <div class="search-bar">
            <span class="material-icons" style="color:var(--text-muted); font-size:18px">search</span>
            <input type="text" id="search" placeholder="Search Channels, Countries...">
        </div>
    </header>
    <div id="channel-grid"></div>
</main>

<div id="player-modal" class="player-modal">
    <div class="player-header"><button class="close-btn" onclick="closePlayer()"><span class="material-icons">close</span></button></div>
    <div class="player-container">
        <video id="video" controls autoplay playsinline></video>
        <div id="player-error" class="offline-container">
            <span class="material-icons">cloud_off</span>
            <h3>Channel Offline</h3>
            <p id="error-msg"></p>
            <button class="retry-btn" onclick="retryStream()"><span class="material-icons">refresh</span> Try Again</button>
        </div>
    </div>
</div>

<script>
    const BASE_URL = 'https://iptv-org.github.io/iptv';
    const hls = new Hls();
    let allChannels = [], favorites = JSON.parse(localStorage.getItem('gltp_favs') || '[]');
    let currentCat = 'news', isFavView = false, lastUrl = '';
    const video = document.getElementById('video');
    
    // FIX: Encoded SVG to avoid quote conflicts in HTML strings
    const svgFallback = "data:image/svg+xml;charset=utf-8," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="#2081e2" stroke-width="1.5"><rect x="2" y="7" width="20" height="15" rx="2"/><polyline points="17 2 12 7 7 2"/></svg>');

    const categories = [
        { id: 'animation', name: 'Animation' }, { id: 'auto', name: 'Auto' }, { id: 'business', name: 'Business' },
        { id: 'classic', name: 'Classic' }, { id: 'comedy', name: 'Comedy' }, { id: 'cooking', name: 'Cooking' },
        { id: 'culture', name: 'Culture' }, { id: 'documentary', name: 'Documentary' }, { id: 'education', name: 'Education' },
        { id: 'entertainment', name: 'Entertainment' }, { id: 'family', name: 'Family' }, { id: 'general', name: 'General' },
        { id: 'interactive', name: 'Interactive' }, { id: 'kids', name: 'Kids' }, { id: 'legislative', name: 'Legislative' },
        { id: 'lifestyle', name: 'Lifestyle' }, { id: 'movies', name: 'Movies' }, { id: 'music', name: 'Music' },
        { id: 'news', name: 'News' }, { id: 'outdoor', name: 'Outdoor' }, { id: 'public', name: 'Public' },
        { id: 'relax', name: 'Relax' }, { id: 'religious', name: 'Religious' }, { id: 'science', name: 'Science' },
        { id: 'series', name: 'Series' }, { id: 'shop', name: 'Shop' }, { id: 'sports', name: 'Sports' }, 
        { id: 'travel', name: 'Travel' }, { id: 'weather', name: 'Weather' }, { id: 'undefined', name: 'Undefined' }
    ];

    const languages = [
        { id: 'eng', name: 'English' }, { id: 'spa', name: 'Spanish' }, { id: 'fra', name: 'French' },   
        { id: 'ara', name: 'Arabic' }, { id: 'rus', name: 'Russian' }, { id: 'ita', name: 'Italian' },   
        { id: 'deu', name: 'German' }, { id: 'por', name: 'Portuguese' }, { id: 'hin', name: 'Hindi' },   
        { id: 'zho', name: 'Chinese' }, { id: 'nld', name: 'Dutch' }, { id: 'ind', name: 'Indonesian' }
    ];

    function initSidebar() {
        const catList = document.getElementById('category-list');
        const langList = document.getElementById('language-list');
        categories.sort((a,b) => a.name.localeCompare(b.name)).forEach(cat => {
            const div = document.createElement('div');
            div.className = "nav-item"; div.id = `cat-${cat.id}`;
            div.innerHTML = `<span class="material-icons">chevron_right</span> ${cat.name}`;
            div.onclick = () => loadM3U(cat.id);
            catList.appendChild(div);
        });
        languages.forEach(lang => {
            const div = document.createElement('div');
            div.className = "nav-item"; div.id = `cat-${lang.id}`;
            div.innerHTML = `<span class="material-icons">language</span> ${lang.name}`;
            div.onclick = () => loadM3U(lang.id, true);
            langList.appendChild(div);
        });
    }
    
    async function checkApiStatus() {
    const dot = document.getElementById('status-dot');
    const text = document.getElementById('status-text');
    
    try {
        // Try to fetch a tiny file from the source to check connectivity
        const response = await fetch('https://iptv-org.github.io/iptv/categories/news.m3u', { method: 'HEAD' });
        
        if (response.ok) {
            dot.className = 'status-dot online';
            text.innerText = 'System Live';
        } else {
            throw new Error();
        }
    } catch (e) {
        dot.className = 'status-dot'; // Reverts to orange/offline color
        dot.style.background = '#ff4d4d'; // Red for error
        dot.style.boxShadow = '0 0 8px #ff4d4d';
        text.innerText = 'Connection Error';
    }
}

// Run the check when the page loads


// Optional: Re-check every 30 seconds
setInterval(checkApiStatus, 30000);

    async function loadM3U(id, isLang = false) {
        currentCat = id; isFavView = false;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        const grid = document.getElementById('channel-grid');
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:50px;opacity:0.5">Loading Streams...</div>';
        try {
            let url = id === 'countries' ? `${BASE_URL}/index.m3u` : (isLang ? `${BASE_URL}/languages/${id}.m3u` : `${BASE_URL}/categories/${id}.m3u`);
            const res = await fetch(url);
            const text = await res.text();
            allChannels = parseM3U(text, id.toUpperCase());
            renderChannels(allChannels);
            const nav = document.getElementById(`cat-${id}`);
            if(nav) nav.classList.add('active');
            if(window.innerWidth <= 768) toggleSidebar();
        } catch (e) { grid.innerHTML = 'Load error.'; }
    }

    function parseM3U(data, catLabel) {
        const channels = [], lines = data.split('\n');
        let cur = null;
        lines.forEach(l => {
            if (l.startsWith('#EXTINF:')) {
                cur = { 
                    name: l.split(',')[1]?.trim(), 
                    logo: l.match(/tvg-logo="([^"]*)"/)?.[1] || '', 
                    cat: catLabel,
                    country: (l.match(/tvg-country="([^"]*)"/)?.[1] || '').toUpperCase(),
                    lang: (l.match(/tvg-language="([^"]*)"/)?.[1] || '').toUpperCase()
                };
            } else if (l.startsWith('http') && cur) {
                cur.url = l.trim(); channels.push(cur); cur = null;
            }
        });
        return channels;
    }

    function renderChannels(list) {
        const grid = document.getElementById('channel-grid');
        grid.innerHTML = '';

        if (isFavView && list.length === 0) {
            grid.innerHTML = `<div class="empty-container"><span class="material-icons">favorite_border</span><h3>No Favorites Yet</h3><p>Tap the heart icon on any channel to save it here.</p></div>`;
            return;
        }

        list.slice(0, 400).forEach(ch => {
            const isFav = favorites.some(f => f.url === ch.url);
            const card = document.createElement('div');
            card.className = 'channel-card';
            
            // Fixed img tag logic: use encoded fallback and clean onerror
            card.innerHTML = `
                <span class="material-icons heart-btn ${isFav ? 'is-fav' : ''}">favorite</span>
                <img src="${ch.logo || svgFallback}" onerror="this.onerror=null; this.src='${svgFallback}'; this.style.opacity='0.2';">
                <div class="ch-info">
                    <div class="ch-name">${ch.name}</div>
                    <div class="meta-tags">
                        ${ch.country ? `<span class="ch-tag">üìç ${ch.country}</span>` : ''}
                        ${ch.lang ? `<span class="ch-tag">üåê ${ch.lang}</span>` : ''}
                    </div>
                </div>`;

            card.querySelector('.heart-btn').onclick = (e) => { 
                e.stopPropagation(); 
                toggleFav(ch); 
            };
            
            card.onclick = () => openPlayer(ch);
            grid.appendChild(card);
        });
    }

    function toggleFav(ch) {
        const idx = favorites.findIndex(f => f.url === ch.url);
        idx > -1 ? favorites.splice(idx, 1) : favorites.push(ch);
        localStorage.setItem('gltp_favs', JSON.stringify(favorites));
        isFavView ? renderChannels(favorites) : renderChannels(allChannels.filter(c => c.name.toLowerCase().includes(document.getElementById('search').value.toLowerCase())));
    }

    function openPlayer(ch) {
        lastUrl = ch.url;
        document.getElementById('player-error').style.display = 'none';
        document.getElementById('video').style.display = 'block';
        document.getElementById('error-msg').innerHTML = `Could not load the stream data for **${ch.name}**. The channel may be offline.`;
        document.getElementById('player-modal').style.display = 'flex';
        
        if (Hls.isSupported()) {
            hls.detachMedia(); 
            hls.loadSource(ch.url); 
            hls.attachMedia(video);
            hls.on(Hls.Events.ERROR, (event, data) => { if(data.fatal) showPlayerError(); });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = ch.url;
            video.onerror = () => showPlayerError();
        }
    }

    function showPlayerError() {
        document.getElementById('video').style.display = 'none';
        document.getElementById('player-error').style.display = 'block';
    }

    function retryStream() { if(lastUrl) openPlayer({url: lastUrl, name: "Selected Channel"}); }
    function closePlayer() { document.getElementById('player-modal').style.display = 'none'; hls.detachMedia(); video.pause(); }
    function showFavorites() { isFavView = true; renderChannels(favorites); document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); document.getElementById('fav-link').classList.add('active'); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
    function manualRefresh() { location.reload(); }
    function clearCache() { if(confirm("Clear favorites?")) { localStorage.removeItem('gltp_favs'); location.reload(); } }

    document.getElementById('search').addEventListener('input', e => {
        const term = e.target.value.toLowerCase();
        renderChannels(allChannels.filter(c => c.name.toLowerCase().includes(term) || c.country.toLowerCase().includes(term)));
    });

    initSidebar(); checkApiStatus(); loadM3U('news');
</script>
</body>
</html>
